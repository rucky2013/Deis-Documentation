备份和还原数据
------------


尽管部署在Deis上的应用因遵循12因子的方法学而无状态，Deis却需要在存储（Store）部件维护着平台的状态。

存储部件运行着Ceph，数据库组件（Database）,注册表组件（Registry）,控制器组件（Controller）和日志组件（Logger）都需要把存储组件（Store）当做一个数据存储来使用。数据库组件和注册表组件使用存储网关（store-gateway）,控制器和日志组件使用存储卷（store-volume）。这些组件有了存储组件作为后备，可以自由的在集群上移动，因为他们的状态有存储组件做后备。

假如一个主机失效然后重新加入集群，根据配置存储组件仍然会以降级的状态运作，并且会自动的恢复。Ceph的数据完全丢失只可能发生在所有的存储容器被移除的情形下。然而，备份Ceph相当直接简单，我们建议在升级Deis之前进行备份。



存放在Ceph中的数据可以通过两个地方访问到：在CoreOS文件系统的/var/lib/deis/store下，和存储网关组件（store-gateway）。备份此份数据也比较简单，我们可以把该文件系统的数据做一个tar包，然后使用任何S3兼容的blob存储工具将存储网关所有的文件下载下来。


### 设置

Deis的存储网关组件对外暴露了一个S3兼容的API，因而我们可以使用如s3cmd来操作存储（object store）服务。首先请安装我们的fork的s3cmd，里面包含了支持ceph的补丁。

```
$ pip install git+https://github.com/deis/s3cmd
```

我们需要生成了的访问key（access key）和秘钥key（secret kejy）来使用存储网关。我们可以通过在集群上的任意一台主机，或者通过在设置了DEISCTL_TUNNEL的远程主机上使用deisctl来获取访问key和秘钥key。

```
$ deisctl config store get gateway/accessKey
$ deisctl config store get gateway/secretKey
```

回到本地主机，运行s3cmd --configure并且输入你的访问key和秘钥key。其他设置都可以不修改使用默认值。如果配置脚本提示你测试下身份验证，略过此步骤 - 它会去Amazon S3做验证然后肯定会返回失败。

你需要更改一些其他的设置。首先，编辑`~/.s3cfg`文件然后修改`host_base`和`host_bucket`的值，使它们与deis-store.<your domain>一致。比如，在我本地的Vagrant主机上，我做了如下修改：

```
host_base = deis-store.local3.deisapp.com
host_bucket = deis-store.local3.deisapp.com/%(bucket)
```

你还需要开启`use_path_mode`模式：

```
use_path_mode = True
```

现在我们可以使用s3cmd命令通过存储网关做备份和还原的操作了。
